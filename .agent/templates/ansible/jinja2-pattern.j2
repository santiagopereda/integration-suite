{# Ansible Jinja2 Templating Best Practices #}
{# This file demonstrates common Jinja2 patterns used in Ansible templates #}

{# === COMMENTS === #}
{# This is a comment - not rendered in final output #}
{# Use comments to explain template logic #}

{# === VARIABLES === #}
{# Simple variable substitution #}
Application Name: {{ app_name }}
Version: {{ app_version }}
Port: {{ app_port }}

{# === DEFAULTS AND FILTERS === #}
{# Provide default value if variable is undefined #}
Log Level: {{ app_log_level | default('info') }}

{# Mandatory variable (fails if not defined) #}
Database Host: {{ db_host | mandatory }}

{# Common filters #}
Uppercase: {{ app_name | upper }}
Lowercase: {{ app_name | lower }}
Capitalize: {{ app_name | capitalize }}
String length: {{ app_name | length }}

{# === CONDITIONALS === #}
{# Simple if statement #}
{% if app_enable_ssl %}
SSL Enabled: true
SSL Certificate: {{ ssl_cert_path }}
SSL Key: {{ ssl_key_path }}
{% endif %}

{# If-else #}
{% if app_environment == 'production' %}
Debug: false
Log Level: warning
{% else %}
Debug: true
Log Level: debug
{% endif %}

{# If-elif-else #}
{% if app_environment == 'production' %}
Mode: production
{% elif app_environment == 'staging' %}
Mode: staging
{% else %}
Mode: development
{% endif %}

{# === LOOPS === #}
{# Loop over list #}
Allowed IPs:
{% for ip in allowed_ips %}
  - {{ ip }}
{% endfor %}

{# Loop over dictionary #}
Database Configuration:
{% for key, value in app_database.items() %}
  {{ key }}: {{ value }}
{% endfor %}

{# Loop with index #}
Servers:
{% for server in web_servers %}
  Server{{ loop.index }}: {{ server }}
{% endfor %}

{# Loop with conditional #}
Active Services:
{% for service in services %}
{% if service.enabled %}
  - {{ service.name }} on port {{ service.port }}
{% endif %}
{% endfor %}

{# === LOOP VARIABLES === #}
{# Special loop variables available inside loops #}
Items:
{% for item in items %}
  Index: {{ loop.index }}          {# 1-indexed #}
  Index0: {{ loop.index0 }}         {# 0-indexed #}
  First: {{ loop.first }}           {# true on first iteration #}
  Last: {{ loop.last }}             {# true on last iteration #}
  Length: {{ loop.length }}         {# total items #}
  Item: {{ item }}
{% endfor %}

{# === TESTS === #}
{# Check if variable is defined #}
{% if app_custom_config is defined %}
Custom Config: {{ app_custom_config }}
{% endif %}

{# Check if variable is undefined #}
{% if app_optional_feature is undefined %}
# Optional feature not configured
{% endif %}

{# Other common tests #}
{% if app_port is number %}
Port is numeric: {{ app_port }}
{% endif %}

{% if app_services is iterable %}
# Services list is iterable
{% endif %}

{# === FILTERS === #}
{# String manipulation #}
Trimmed: {{ " value " | trim }}
Replaced: {{ "hello world" | replace("world", "ansible") }}
Regex: {{ "v1.2.3" | regex_replace('^v', '') }}

{# List manipulation #}
First Item: {{ my_list | first }}
Last Item: {{ my_list | last }}
Joined: {{ my_list | join(', ') }}
Unique Items: {{ my_list | unique }}
Sorted: {{ my_list | sort }}

{# Dictionary manipulation #}
Keys: {{ my_dict | dict2items | map(attribute='key') | list }}
Values: {{ my_dict | dict2items | map(attribute='value') | list }}

{# Math filters #}
Absolute: {{ -42 | abs }}
Random: {{ 100 | random }}
Round: {{ 3.14159 | round(2) }}

{# Date/Time #}
Current Date: {{ ansible_date_time.iso8601 }}
Year: {{ ansible_date_time.year }}

{# JSON/YAML #}
JSON: {{ my_dict | to_json }}
YAML: {{ my_dict | to_yaml }}
Pretty JSON: {{ my_dict | to_nice_json }}

{# Hash/Password #}
SHA256: {{ "password" | hash('sha256') }}
Password Hash: {{ user_password | password_hash('sha512') }}

{# === ANSIBLE-SPECIFIC FILTERS === #}
{# IP address filters #}
{% if ansible_default_ipv4.address is defined %}
IPv4: {{ ansible_default_ipv4.address | ansible.utils.ipaddr }}
Network: {{ ansible_default_ipv4.address | ansible.utils.ipaddr('network') }}
{% endif %}

{# File path filters #}
Basename: {{ "/path/to/file.txt" | basename }}
Dirname: {{ "/path/to/file.txt" | dirname }}

{# === MACROS === #}
{# Define reusable template block #}
{% macro print_server(name, port) %}
Server: {{ name }}
Port: {{ port }}
Status: Active
{% endmacro %}

{# Use macro #}
{{ print_server("web1", 80) }}
{{ print_server("web2", 8080) }}

{# === WHITESPACE CONTROL === #}
{# Remove whitespace before #}
{%- if condition %}
content
{% endif %}

{# Remove whitespace after #}
{% if condition -%}
content
{% endif %}

{# Remove both #}
{%- if condition -%}
content
{%- endif -%}

{# === COMPLEX EXAMPLE === #}
{# Nginx virtual host configuration #}
server {
    listen {{ app_port }};
    server_name {{ app_domain }};

{% if app_enable_ssl %}
    listen 443 ssl;
    ssl_certificate {{ ssl_cert_path }};
    ssl_certificate_key {{ ssl_key_path }};
{% endif %}

    root {{ app_web_root }};
    index index.html index.htm;

    location / {
        try_files $uri $uri/ =404;
    }

{% if app_backend_servers is defined %}
    upstream backend {
{% for server in app_backend_servers %}
        server {{ server.host }}:{{ server.port }} weight={{ server.weight | default(1) }};
{% endfor %}
    }

    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
{% endif %}

{% if app_enable_monitoring %}
    location /health {
        access_log off;
        return 200 "healthy\n";
    }
{% endif %}
}

{# === BEST PRACTICES === #}

{# ✅ DO: #}
{# - Use descriptive variable names #}
{# - Provide defaults for optional variables #}
{# - Use filters appropriately (default, mandatory, etc.) #}
{# - Control whitespace with - where needed #}
{# - Comment complex template logic #}
{# - Use macros for repeated blocks #}
{# - Test for undefined before using variables #}

{# ❌ DON'T: #}
{# - Embed complex logic (keep in playbook/role) #}
{# - Use shell execution in templates #}
{# - Leave undefined variables without defaults #}
{# - Create deeply nested conditions #}
{# - Forget to escape special characters #}

{# === DEBUGGING === #}
{# Print variable for debugging #}
{# DEBUG: app_name = {{ app_name }} #}
{# DEBUG: app_database = {{ app_database | to_nice_json }} #}

{# Template Version: 1.0.0 #}
{# Last Updated: 2025-11-28 #}
{# Maintained By: Agent Architecture Team #}
